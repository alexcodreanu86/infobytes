<div class="row">
  <div class="tutorial-header">
  	<h1><%= @tutorial.title %></h1>
  	<p>Description: <%= @tutorial.description %></p>
    <% if tutorial_creator? %>
      <%= link_to "Edit Title & Description", edit_tutorial_path(@tutorial), id: "edit-tutorial-header", data: {"reveal-id" => "popup-chapter"} %> <br>
    <% end %>
    <%= link_to "Download as PDF", pdf_view_tutorial_path(@tutorial, "pdf") %>
  </div>  
  <h2 class="tut-index">Index:</h2>
  <div class="row">
    <div id="chapter-list" class="small-10 small-offset-1">
  		<% @tutorial.chapters.each do |chapter| %>
      	<div class="chapter" id="chapter-<%= chapter.id %>">
          <h3><%= chapter.title %></h3>
          <%= link_to fa_icon('arrow-circle-o-down', class: "fa-2x").html_safe, chapter_path(chapter), class: "sub-cpt-list add-list" %>
          <% if tutorial_creator? %>
            <%= link_to '<i class="fa fa-trash-o fa-2x del-chapter"></i>'.html_safe, chapter_path(chapter), method: :delete, data: { confirm: "Are you sure?" }, class: "delete-chapter delete" %> 
          <% end %>
        <div class="small-11 small-offset-1" id="cpt-<%= chapter.id %>" style="display: none;"></div>
        </div>
  		<% end %>
    </div>
  </div>

	<% if tutorial_creator? %>
    <%= link_to "Add Chapter <i class='fa fa-plus-square fa-2x'></i>".html_safe, new_tutorial_chapter_path(@tutorial), id: "add-chapter", data: {"reveal-id" => "modal-popup"}%>
    <div id="chapter-form" style="display: none;"></div>
	<% end %>
 
</div>

<div id="popup-chapter" class="reveal-modal" data-reveal></div>
<div id="popup-sub-chapter" class="reveal-modal" data-reveal></div>
<div id="popup-sub-chapter-full" class="reveal-modal" data-reveal></div>



<script>
  $(document).foundation();
  
  /************************************************************************
  * Pull in full sub chapter for reading the contents if user not creator
  *************************************************************************/

  $("#chapter-list").on("click", ".sub-chapter-link", function(e){
    e.preventDefault();
    var url = $(this).attr("href");

    $.get(url, function(serverResponse, status, request){
      $("#modal-popup").html(serverResponse);
      $("#modal-popup").append("<a class='close-reveal-modal'>&#215;</a>")
    });
  });

  /************************************************************************
   *  Helper method to switch the arrow down or up when it is clicked
   ************************************************************************/


  var switchArrow = function(link){
    var icon = $(link).children()[0]
    if ($(icon).attr("class").match("down") !== null) {
      $(icon).removeClass("fa fa-arrow-circle-o-down fa-2x");
      $(icon).addClass("fa fa-arrow-circle-o-up fa-2x");
    } else {
      $(icon).removeClass("fa fa-arrow-circle-o-up fa-2x");
      $(icon).addClass("fa fa-arrow-circle-o-down fa-2x");
      $(link).attr("class", "sub-cpt-list")
    }
  }

  /************************************************************************
  * Pull in/ take out sub chapters list for the clicked chapter arrow
  *************************************************************************/

  $("#chapter-list").on("click", ".sub-cpt-list",  function(e){
    e.preventDefault();
    var link = this;

    if ($(this).attr('class').match("add-list") !== null){
      bring_list(link);
    } else {
      take_list_off(link);
    }
  })

  var bring_list = function(link){
    switchArrow(link);
    var url = $(link).attr("href")
    var id = url.match(/\d+/)[0];

    $.get(url, function(serverResponse, status, request){
      $("#cpt-" + id).html(serverResponse).slideDown();
    }).done(function(){
      $(link).removeClass("add-list").addClass('remove-list')
      $(".delete-sub-chapter").removeAttr("data-confirm").removeAttr("data-method")
    })
  }

  var take_list_off = function(link){
    var id = $(link).attr('href').match(/\d+/)[0]
    switchArrow(link);
    $('#cpt-' + id).toggle("fade");
    $(link).removeClass("remove-list").addClass('add-list')
  }

</script>

<% if tutorial_creator? %>
  <script>

    /*******************************************************************
    * Pulls in the form to create a chapter 
    ********************************************************************/

    $('#add-chapter').on("click", function(e){
    	e.preventDefault();
      var url = $(this).attr("href");
            
    	$.get(url, function(serverResponse, status, request){
        $("#popup-chapter").html(serverResponse);
      })
    });
    
    /*******************************************************************
    * Append new chapter to the list
    ********************************************************************/

    var appendChapter = function(chapter){
      $("#chapter-list").append("<div class='chapter' id='chapter-" + chapter.id + "'><h3>" + chapter.title + "</h3> <a class='sub-cpt-list add-list' href='/chapters/" + chapter.id + "'><i class='fa fa-arrow-circle-o-down fa-2x'></i></a> <a class='delete-chapter' href='/chapters/" + chapter.id + "' rel='nofollow'><i class='del-chapter fa fa-trash-o fa-2x'></i></a> <div class='small-11 small-offset-1' id='cpt-"+ chapter.id + "' style='display: none;'></div></div>");
       $("#popup-chapter").foundation("reveal", "close");
    }

  	$('#popup-chapter').on("submit", "#new_chapter", function(e){
      e.preventDefault();
      
      var data = $(this).serialize();
      var url = $(this).attr("action");

      if ($('#chapter_title').val() === "") {
        $("#chapter_title").css("border-color", "red")
      } else {
        $.post(url, data, function(serverResponse, status, request){
          var chapter = serverResponse; 
          appendChapter(chapter)
        }, "json");
      };
  	});

    /********************************************************************
    * Pulls in form to create sub chapter
    *********************************************************************/

    $("#chapter-list").on("click", '.add-sub-chapter', function(e){
      e.preventDefault();
      var url = $(this).attr("href");
      var id = url.match(/\d+/)[0]

      $.get(url, function(serverResponse, status, request){
        $("#popup-sub-chapter").html(serverResponse);
      });
    });

    /********************************************************************
    * Appends subchapter to coresponding list
    *********************************************************************/

    var appendSubchapter = function(subChapter, chapter){
      $("#sub-chapter-list-" + chapter.id).append("<div class='sub-chapter' id='sub-chapter-" + subChapter.id + "'><h4><a href='/sub_chapters/" + subChapter.id + "'>" + subChapter.title + "</a></h4><a class='delete-sub-chapter' href='/sub_chapters/" + subChapter.id + "'><i class='fa fa-trash-o fa-2x del-sub-chapter'></i></a> </div>");
        $("#sub-chapter-form-" + chapter.id).slideUp(200);
        $("#popup-sub-chapter").foundation("reveal", "close");
    }


    $('#popup-sub-chapter').on("submit", "#new_sub_chapter", function(e){
      e.preventDefault();
      
      var data = $(this).serialize();
      var url = $(this).attr("action");

      if ($('#sub_chapter_title').val() === "") {
        $("#sub_chapter_title").css("border-color", "red")
      } else {
        $.post(url, data, function(serverResponse, status, request){
          var subChapter = serverResponse.sub_chapter;
          var chapter = serverResponse.chapter;
          appendSubchapter(subChapter, chapter);
        }, "json");
      };
    });

    //********************************
    // Deleting chapters 
    // *******************************

    $(".delete").removeAttr("data-confirm").removeAttr("data-method")
  

    $("#chapter-list").on('click', ".delete-chapter", function(e){
      e.preventDefault();
      var result = window.confirm("Are you sure you want to delete this chapter?")
      if (result){
        var chpUrl = $(this).attr("href")
        var id = chpUrl.match(/\d+/)[0]
        $('#chapter-' + id).toggle('fade',function(){
          $('#chapter-' + id).remove();
        });
        $.ajax({
          url: chpUrl,
          type: "DELETE",
          success: "great:success"
        }, "json")
      }     
    })

    /********************************
    * Deleting sub-chapters 
    *********************************/

    $("#chapter-list").on('click', ".delete-sub-chapter", function(e){
      e.preventDefault();
      var result = window.confirm("Are you sure you want to delete this sub-chapter?")
      if (result){
        var subChpUrl = $(this).attr("href")
        var id = subChpUrl.match(/\d+/)[0]
        console.log(subChpUrl)
        console.log(id)

        $.ajax({
          url: subChpUrl,
          type: "DELETE",
          success: "great:success"
        }, "json").done(function(){
          $('#sub-chapter-' + id).toggle('fade',function(){ $('#sub-chapter-' + id).remove(); });

        })
      }     
    })

    /********************************
    * Editing Tutorial Link
    *********************************/
    
    $("#edit-tutorial-header").on("click", function(e){
      e.preventDefault();
      
      var url = $(this).attr("href");

      $.get(url, function(serverResponse, status, request){
        $("#popup-chapter").html(serverResponse);
        $("#popup-chapter").append("<a class='close-reveal-modal'>&#215;</a>");
      });
    });

    $("#popup-chapter").on("submit", "#tut-form", function(e){
      e.preventDefault();
      consol.log("pass")
      var url = $(this).attr("action");
      var data = $(this).serialize();
      // $.post(url, data, function(serverResponse, status, request){
      //   console.log(serverResponse);
      // }, "json");
    });
    
  </script>
<% end %>



<%#= render "tutorials/display_tutorial" %>


